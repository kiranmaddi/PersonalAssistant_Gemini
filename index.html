<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Assistant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for animations and general layout */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .animate-modalEnter {
            animation: modalEnter 0.3s ease-in-out forwards;
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-slideIn {
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    <div id="app-root">
        <!-- App content will be rendered here -->
    </div>
    <div id="event-form-modal-container"></div>
    <div id="task-form-modal-container"></div>
    <div id="import-export-modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>
    <div id="confirm-modal-container"></div>


    <script type="module">
        // Core Imports
        import { initializeFirebase, userId, setRenderCallbacks as setFirebaseRenderCallbacks } from './firebase-setup.js';
        import { fetchEvents, fetchTasks, getEvents, getTasks, saveEvent, deleteEvent, markEventOccurrenceDone, saveTask, deleteTask, markTaskOccurrenceDone, setDataCallbacks } from './data-service.js';
        import { showToast, showConfirmModal, openEventFormModal, closeEventFormModal, openTaskFormModal, closeTaskFormModal, openImportExportModal, closeImportExportModal, renderEventFormModal, renderTaskFormModal, renderImportExportModal, renderEventItem, renderTaskItem, getEventFormModalState, getEditingEventState, getTaskFormModalState, getEditingTaskState, getImportExportModalState, setUICallbacks } from './ui-components.js';
        import { getTodayDateString } from './utilities.js';
        import { exportAllData, importAllData } from './import-export.js';
        import { renderCalendarView, changeCalendarMonth, changeCalendarYear, handleDayClick } from './calendar-logic.js';


        // --- Application State ---
        let currentView = 'dashboard'; // 'dashboard', 'events', 'tasks', 'calendar'
        let events = []; // This will be updated by data-service callbacks
        let tasks = [];  // This will be updated by data-service callbacks
        let currentCalendarDate = new Date(); // State for the calendar view

        // --- DOM Elements ---
        const appRoot = document.getElementById('app-root');
        const eventFormModalContainer = document.getElementById('event-form-modal-container');
        const taskFormModalContainer = document.getElementById('task-form-modal-container');
        const importExportModalContainer = document.getElementById('import-export-modal-container');


        // --- Callback Functions for Modules to Update App State ---

        // Callback for data-service to update events in main app state
        const handleUpdateEvents = (newEvents) => {
            events = newEvents;
            renderApp(); // Re-render when events state changes
        };

        // Callback for data-service to update tasks in main app state
        const handleUpdateTasks = (newTasks) => {
            tasks = newTasks;
            renderApp(); // Re-render when tasks state changes
        };

        // Callback for UI components to trigger main app re-render
        const triggerAppRender = () => {
            renderApp();
        };

        // Callback for UI components to handle navigation (e.g., day click in calendar)
        const navigateTo = (view, data = {}) => {
            currentView = view;
            if (view === 'calendar' && data.date) {
                // If navigating to calendar with a specific date, update calendar state
                currentCalendarDate = new Date(data.date);
            }
            renderApp();
        };

        // --- Main App Rendering Function ---
        const renderApp = () => {
            console.log("renderApp called. Current View:", currentView, "User ID:", userId);
            let content = '';

            // Show loading spinner if userId is not yet available (Firebase still authenticating)
            if (!userId) {
                content = `
                    <div class="flex items-center justify-center min-h-screen bg-gray-100">
                        <div class="text-center p-8 bg-white rounded-lg shadow-xl">
                            <div class="flex items-center justify-center mb-4">
                                <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="ml-3 text-lg text-gray-700">Loading user data...</p>
                            </div>
                            <p class="text-gray-600">Please wait while we set up your personal assistant.</p>
                        </div>
                    </div>
                `;
            } else {
                // Main application structure once authenticated
                content = `
                    <div class="min-h-screen bg-gray-100">
                        <header class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center rounded-b-lg">
                            <h1 class="text-3xl font-bold">Personal Assistant</h1>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm">User ID: ${userId}</span>
                                <button onclick="window.openImportExportModal()" class="bg-indigo-700 hover:bg-indigo-800 px-4 py-2 rounded-md transition duration-300">
                                    Import/Export
                                </button>
                            </div>
                        </header>

                        <nav class="bg-white shadow-sm p-3 mt-4 mx-4 rounded-lg flex justify-around">
                            <button onclick="currentView = 'dashboard'; renderApp();"
                                class="px-5 py-2 rounded-md font-medium transition duration-300 ${currentView === 'dashboard' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}">
                                Dashboard
                            </button>
                            <button onclick="currentView = 'events'; renderApp();"
                                class="px-5 py-2 rounded-md font-medium transition duration-300 ${currentView === 'events' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}">
                                Events
                            </button>
                            <button onclick="currentView = 'tasks'; renderApp();"
                                class="px-5 py-2 rounded-md font-medium transition duration-300 ${currentView === 'tasks' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}">
                                Tasks
                            </button>
                            <button onclick="currentView = 'calendar'; renderApp();"
                                class="px-5 py-2 rounded-md font-medium transition duration-300 ${currentView === 'calendar' ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50'}">
                                Calendar
                            </button>
                        </nav>

                        <main class="p-4">
                `;

                // Render content based on currentView
                if (currentView === 'dashboard') {
                    const todayDate = getTodayDateString();
                    const dashboardEvents = getEvents(); // Get current events from data service
                    const dashboardTasks = getTasks();   // Get current tasks from data service

                    content += `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Upcoming Events</h2>
                                ${dashboardEvents.length > 0 ?
                                    `<ul class="list-disc list-inside text-left">
                                        ${dashboardEvents.slice(0, 3).map(event => `<li>${event.title} on ${event.date}</li>`).join('')}
                                    </ul>` :
                                    '<p class="text-gray-600">No upcoming events.</p>'}
                                <button onclick="currentView = 'events'; renderApp();" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md transition duration-300">View All Events</button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Pending Tasks</h2>
                                ${dashboardTasks.filter(task => !(task.completedOccurrences || []).includes(todayDate)).length > 0 ?
                                    `<ul class="list-disc list-inside text-left">
                                        ${dashboardTasks.filter(task => !(task.completedOccurrences || []).includes(todayDate)).slice(0, 3).map(task => `<li>${task.title} (Due: ${task.dueDate})</li>`).join('')}
                                    </ul>` :
                                    '<p class="text-gray-600">No pending tasks.</p>'}
                                <button onclick="currentView = 'tasks'; renderApp();" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md transition duration-300">View All Tasks</button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                                <button onclick="window.openEventFormModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition duration-300 mb-2 w-full">Add New Event</button>
                                <button onclick="window.openTaskFormModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition duration-300 w-full">Add New Task</button>
                            </div>
                        </div>
                    `;
                } else if (currentView === 'events') {
                    const allEvents = getEvents(); // Get current events from data service
                    content += `
                        <div class="flex justify-between items-center mb-6 mt-6">
                            <h2 class="text-3xl font-bold text-gray-800">Your Events</h2>
                            <button onclick="window.openEventFormModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-md shadow-lg transition duration-300 flex items-center space-x-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Add Event</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            ${allEvents.length > 0 ? allEvents.map(renderEventItem).join('') : '<p class="text-gray-600">No events found. Add one!</p>'}
                        </div>
                    `;
                } else if (currentView === 'tasks') {
                    const allTasks = getTasks(); // Get current tasks from data service
                    content += `
                        <div class="flex justify-between items-center mb-6 mt-6">
                            <h2 class="text-3xl font-bold text-gray-800">Your Tasks</h2>
                            <button onclick="window.openTaskFormModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-md shadow-lg transition duration-300 flex items-center space-x-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>Add Task</span>
                            </button>
                        </div>
                        <div class="space-y-4">
                            ${allTasks.length > 0 ? allTasks.map(renderTaskItem).join('') : '<p class="text-gray-600">No tasks found. Add one!</p>'}
                        </div>
                    `;
                } else if (currentView === 'calendar') {
                    // Render calendar view using the calendarLogic module
                    content += renderCalendarView(currentCalendarDate, getEvents(), getTasks(), navigateTo);
                }

                content += `
                        </main>
                    </div>
                `;
            }

            appRoot.innerHTML = content;

            // Render modals based on their state managed by ui-components.js
            if (getEventFormModalState()) {
                renderEventFormModal();
            } else {
                eventFormModalContainer.innerHTML = '';
            }
            if (getTaskFormModalState()) {
                renderTaskFormModal();
            } else {
                taskFormModalContainer.innerHTML = '';
            }
            if (getImportExportModalState()) {
                renderImportExportModal();
                // Attach specific import/export logic to buttons
                document.getElementById('export-json-btn').onclick = () => {
                    document.getElementById('importExportData').value = exportAllData();
                    showToast('Data exported as JSON! Copy from the text area.', 'success');
                };
                document.getElementById('import-json-btn').onclick = async () => {
                    const jsonData = document.getElementById('importExportData').value;
                    await importAllData(jsonData);
                };
                // CSV export buttons are now also handled within ui-components.js
            } else {
                importExportModalContainer.innerHTML = '';
            }
        };


        // --- Global Exposures (Crucial for inline onclick attributes) ---
        // Expose functions from modules to the global window object so HTML can call them
        window.openEventFormModal = openEventFormModal;
        window.closeEventFormModal = closeEventFormModal;
        window.openTaskFormModal = openTaskFormModal;
        window.closeTaskFormModal = closeTaskFormModal;
        window.openImportExportModal = openImportExportModal;
        window.closeImportExportModal = closeImportExportModal;
        // Data service actions
        window.markEventOccurrenceDone = markEventOccurrenceDone;
        window.deleteEvent = deleteEvent;
        window.markTaskOccurrenceDone = markTaskOccurrenceDone;
        window.deleteTask = deleteTask;
        // Calendar actions
        window.changeCalendarMonth = (offset, timestamp) => {
            currentCalendarDate = calendarLogic.changeCalendarMonth(offset, new Date(timestamp));
            renderApp();
        };
        window.changeCalendarYear = (offset, timestamp) => {
            currentCalendarDate = calendarLogic.changeCalendarYear(offset, new Date(timestamp));
            renderApp();
        };
        window.handleCalendarDayClick = (dateString) => {
            handleDayClick(dateString, navigateTo); // Pass app's navigateTo for handling day clicks
        };


        // --- Initialization ---
        window.onload = () => {
            console.log("Window loaded. Starting app initialization.");

            // 1. Set up callbacks for Firebase to trigger app renders and data fetches
            setFirebaseRenderCallbacks(renderApp, fetchEvents, fetchTasks);

            // 2. Set up callbacks for Data Service to update main app's state and show toasts
            setDataCallbacks(handleUpdateEvents, handleUpdateTasks, showToast);

            // 3. Set up callbacks for UI Components to trigger main app renders and navigation
            setUICallbacks(triggerAppRender, navigateTo, showToast);
            
            // 4. Initialize Firebase (this will trigger auth and then data fetching)
            initializeFirebase();

            // 5. Initial render of the app (will show loading spinner first)
            renderApp();

            // Ensure Lucide icons are created for initial static HTML
            lucide.createIcons();
        };

        // Mutation Observer to re-create Lucide icons whenever the DOM is updated dynamically
        const observer = new MutationObserver(() => {
            lucide.createIcons();
        });
        observer.observe(appRoot, { childList: true, subtree: true });
        observer.observe(eventFormModalContainer, { childList: true, subtree: true });
        observer.observe(taskFormModalContainer, { childList: true, subtree: true });
        observer.observe(importExportModalContainer, { childList: true, subtree: true });
        document.addEventListener('DOMContentLoaded', () => {
            const confirmModalContainer = document.getElementById('confirm-modal-container');
            if (confirmModalContainer) {
                observer.observe(confirmModalContainer, { childList: true, subtree: true });
            }
        });


    </script>
</body>
</html>
